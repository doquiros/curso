<!DOCTYPE html>
<html>
<head>
<title>Calculadora</title>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Orbitron:400,700" rel="stylesheet">
<style>
	#calculadora {
		border: 1px solid black;
		width: 20em;
		padding: 0em 1em 1em 1em;
		background-color: lightgrey;
		background-clip: border-box;
	}
	input {
		font-family: "Orbitron", sans-serif;
		font-size: 20px;
		text-align: right;
	}
	#answer-box {
		width: inherit;
	}
	#answer {
		border: 1px solid black;
		font-size: 20px;
		width: 100%;
		font-family: "Orbitron", sans-serif;
		background-color: olive;
		background-clip: border-box;
		text-align: right;
	}
	#op-buttons {
		display: grid;
		grid-template-columns: repeat(5, 1fr);
		grid-template-rows: repeat(3, 1fr);
		grid-template-areas:
			"mas menos por entre elevado"
			"cuadrado inversa raiz entera null"
			"igual igual igual igual igual";
		grid-gap: 1rem;
	}
	#mas { grid-area: mas; }
	#menos { grid-area: menos; }
	#por { grid-area: por; }
	#entre { grid-area: entre; }
	#elevado { grid-area: elevado; }
	#cuadrado { grid-area: cuadrado; }
	#inversa { grid-area: inversa; }
	#raiz { grid-area: raiz; }
	#entera { grid-area: entera; }
	#igual { grid-area: igual; }
</style>
<script type="text/javascript">
	/* Asociamos un numero a cada operacion:
	 * suma: 0
	 * resta: 1
	 * producto: 2
	 * division: 3
	 * potenciacion: 4
	 * cuadrado: 5
	 * inversa: 6
	 * raiz: 7
	 * parte entera: 8
	 * 
	 * Y otro numero para el tipo de operacion:
	 * unaria: 0
	 * binaria: 1
	 */

	var num, acc = 0, next_op = -1;
	var op2optype = [1, 1, 1, 1, 1, 0, 0, 0, 0];
	
	// Para las operaciones binarias se puede usar el teclado:
	var symbol2op = {"+":0, "-":1, "*":2, "/":3, "^": 4}
	var op2symbol = {0:"+", 1:"-", 2:"*", 3:"/", 4:"^", 5:"^2", 6: "1/x", 7: "sqrt()", 8: "int()"}
	
	function vaciar () { num.value = "";}
	function show_acc()	{ document.getElementById("answer").innerHTML = acc.toString(); }
	function clear_input()	{ num.value = "0"; }
	function historial(msg) { document.getElementById("historial").innerHTML = document.getElementById("historial").innerHTML + "<br/>" + msg; }
	function bindKeys()
	{
		// Vamos a usar el teclado para introducir los numeros y las operaciones binarias. 
		// Las unarias tendran que hacerse obligatoriamente pulsando el boton correspondiente con el raton.
		document.onkeydown = function(e){
			historial("keycode "+e.keyCode);
			historial("key "+e.key);
			
			if(e.key === "-" && next_op !== -1)
			{
				num.value = String.fromCharCode(e.keyCode);
			}
			else if((e.keyCode >= 0x30 && e.keyCode < 0x40) || e.key === ".")
			{	
				if(num.value === "0")
					num.value = String.fromCharCode(e.keyCode);
				else
					num.value += String.fromCharCode(e.keyCode);
			}
			else if (e.keyCode === 0x08)
			{
				num.value = num.value.substring(0,num.value.length - 1);
			}
			else{
				switch (e.key){
					case "=": // tecla enter: igual
						num.blur(0);
						igual();
						break;
					case "*": // tecla *: suma
					case "+": // tecla +: suma
					case "-": // tecla -: resta
					case "^": // tecla ^: potenciacion
						if(num.value !== "")
						{
							num.blur(0);
							calcular(symbol2op[keycode2op[e.keyCode]]);
						}
						break;
					case "/": // tecla / : division
						e.preventDefault();
						num.blur(0);
						calcular(3);
						
						break;
					
				}
			}
		};
	}
	
	function calcular(op)
	{
		if(next_op === -1 && num.value === "0")
			operando = acc;
		else
			operando = num.value;

		if(op2optype[op] === 1)
			do_op = next_op;
		else
			do_op = op;
		
		historial(((do_op > -1)? op2symbol[do_op] : "") + " " + operando);

		next_op = op;
		reset_next_op = 1;
		// Cargar nuevo valor, ejecutando la operacion que nos ordenaron:
		switch(do_op)
		{
			case -1: //asignacion
				acc = +operando;
				reset_next_op = 0;
				break;
			case 0: //suma
				acc = +acc + +operando;
				break;
			case 1: //resta
				acc = +acc - +operando;
				break;
			case 2:  //producto
				acc = +acc * +operando;
				break;
			case 3:  //division
				acc = +acc / +operando;
				break;
			case 4:  //potenciacion
				acc = (+acc) ** (+operando);
				break;
			case 5: //cuadrado
				acc = (+operando) ** 2;
				break;
			case 6: //inversa
				acc = 1 / (+operando);
				break;
			case 7: //raiz
				acc = Math.sqrt(+operando);
				break;
			case 8: //parte entera
				acc = (+operando) >= 0? Math.floor(operando) : Math.ceil(operando);
				break;
			default:
				return;
		}
		acc = acc.toString();

		//Guardamos la operacion a ejecutar con el siguiente valor introducido
		//if(op2optype[op] === 1)
		//	next_op = op;
		//else
		if(reset_next_op === 1)
			next_op = -1;
		//mostramos el resultado
		show_acc();
		//limpiamos la caja de entrada
		clear_input();
	}

	function igual() {
		if(next_op !== -1)
		{
			calcular(next_op);
			historial("= "+acc);
			next_op = -1;
		}
		else
		{
			acc = "0";
			show_acc();
			clear_input();
			historial("= "+acc);
		}
	}

	function inic ()
	{
		num = document.getElementById("num");
		bindKeys();
	}

</script>
</head>
<body onLoad="inic()">
	<h1>Bienvenidos a la calculadora de Daniel Orellana</h1>
	<div id="calculadora" >
		<p id="answer-box">Resultado: <div id="answer"> 0</div></p>
			NÃºmero:<p>
			<input autofocus type="text" pattern="[0-9.+-]*" size="12" id="num" onClick="vaciar()" onInput="dbg()" readonly="readonly"/><p>
		</p>
		<div id="op-buttons">
			<button id="mas" onClick="calcular(0)">+</button>
			<button id="menos" onClick="calcular(1)">-</button>
			<button id="por" onClick="calcular(2)">*</button>
			<button id="entre" onClick="calcular(3)">/</button>
			<button id="elevado" onClick="calcular(4)">x^y</button>	
			<button id="cuadrado" onClick="calcular(5)">x<super>2</super></button>
			<button id="inversa" onClick="calcular(6)">1/x</button>
			<button id="raiz" onClick="calcular(7)">sqrt(x)</button>
			<button id="entera" onClick="calcular(8)">int(x)</button>
			<button id="igual" onClick="igual()">=</button>
		</div>
	</div>
	<div id="historial"></div>
</body>
</html>
